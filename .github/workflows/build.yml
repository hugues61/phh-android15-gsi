name: Build PHH GSI Android 15

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: self-hosted

    env:
      ANDROID_DIR: /media/hugues/6d773edd-ab57-425e-accd-3cb166ced1b7/srv/aosp/android
      CCACHE_DIR: /media/hugues/6d773edd-ab57-425e-accd-3cb166ced1b7/srv/aosp/ccache

    steps:
      - name: Prepare Directories
        run: |
          mkdir -p "$ANDROID_DIR"
          mkdir -p "$CCACHE_DIR"

      - name: Ensure repo in PATH
        run: |
          mkdir -p ~/bin
          if [ ! -f ~/bin/repo ]; then
            curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
            chmod a+x ~/bin/repo
          fi
          echo "$HOME/bin" >> $GITHUB_PATH

      - name: Init or Repair AOSP Tree
        run: |
          set -e
          cd "$ANDROID_DIR"

          if [ ! -d .repo ]; then
            echo "Initializing fresh AOSP tree..."
            repo init \
              -u https://android.googlesource.com/platform/manifest \
              -b android-15.0.0_r1
          fi

          echo "Syncing..."
          if ! repo sync -j$(nproc); then
            echo "Sync failed. Attempting repair..."
            repo forall -c 'git reset --hard' || true
            repo sync -j$(nproc)
          fi

      - name: Clone PHH Treble (if missing)
        run: |
          cd "$ANDROID_DIR"
          if [ ! -d device/phh/treble ]; then
            git clone \
              https://github.com/phhusson/treble_manifest.git \
              -b android-15.0 \
              device/phh/treble
          fi

      - name: Enable IMS Force (safe append)
        run: |
          cd "$ANDROID_DIR"
          if [ -f device/phh/treble/system.prop ]; then
            grep -q persist.sys.phh.ims.force_enable device/phh/treble/system.prop || \
            echo "persist.sys.phh.ims.force_enable=1" >> device/phh/treble/system.prop
          fi

      - name: Build GSI
        run: |
          set -e
          cd "$ANDROID_DIR"

          export USE_CCACHE=1
          export CCACHE_DIR="$CCACHE_DIR"

          source build/envsetup.sh
          lunch treble_arm64_bN-userdebug

          make -j$(nproc) systemimage
