name: Build TrebleDroid Android 15 GSI

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: self-hosted
    env:
      WORK_DIR: /media/hugues/6d773edd-ab57-425e-accd-3cb166ced1b7/aosp
      CCACHE_DIR: /media/hugues/6d773edd-ab57-425e-accd-3cb166ced1b7/ccache
      USE_CCACHE: 1

    steps:
    - name: Prepare directories
      run: |
        mkdir -p "$WORK_DIR"
        mkdir -p "$CCACHE_DIR"

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          git-core repo git-lfs openjdk-21-jdk \
          bc bison build-essential curl flex g++-multilib gcc-multilib \
          gnupg gperf lib32ncurses-dev lib32readline-dev lib32z1-dev \
          liblz4-tool libncurses6 libsdl1.2-dev libssl-dev \
          libxml2-utils lzop pngcrush rsync schedtool squashfs-tools xsltproc \
          zip zlib1g-dev ccache python3

    - name: Setup git
      run: |
        git config --global user.email "builder@local"
        git config --global user.name "Android Builder"

    - name: Init TrebleDroid manifest
      run: |
        cd "$WORK_DIR"
        if [ ! -d .repo ]; then
          # depth=1 saves ~50GB of disk space and hours of sync time
          repo init \
            -u https://github.com \
            -b android-15.0 \
            --depth=1
        fi

    - name: Sync sources
      run: |
        cd "$WORK_DIR"
        repo sync -c -j$(nproc) --no-tags --no-clone-bundle

    - name: Apply TrebleDroid Patches
      run: |
        cd "$WORK_DIR"
        # This is the "secret sauce" that makes it a PHH/Treble GSI
        bash treble_experimentations/apply-patches.sh .

    - name: Configure IMS & Build environment
      run: |
        cd "$WORK_DIR"
        # Using the standard system.prop path for TrebleDroid
        echo "persist.sys.phh.ims.force_enable=1" >> device/phh/treble/system.prop
        ccache -M 80G

    - name: Build GSI
      run: |
        cd "$WORK_DIR"
        source build/envsetup.sh
        
        # A15 uses 'trunk_staging' as the default release config
        # 'v' in bvN stands for 'Vanilla' (AOSP)
        lunch treble_arm64_bvN-trunk_staging-userdebug
        
        make systemimage -j$(nproc)

    - name: Upload image
      uses: actions/upload-artifact@v4
      with:
        name: Android15-GSI
        path: ${{ env.WORK_DIR }}/out/target/product/phh_arm64_a/system.img
